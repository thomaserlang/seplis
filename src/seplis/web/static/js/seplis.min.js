$(function(){$("#form-new-show").submit(function(event){event.preventDefault();api.post("/api/show-new",$(this).serialize(),{done:function(data){location.href="/show/"+data["id"]}})});$("#form-edit-show").submit(function(event){event.preventDefault();api.post("/api/show-edit/"+$(this).attr("show-id"),$(this).serialize(),{done:function(data){$.growl({title:"Success!",message:"The show has been updated.",location:"tc"})}})});if($("#alternative-titles").length){$("#alternative-titles").select2({tags:[]})}$("date.show-date").each(function(){var hours=moment.utc($(this).attr("title"),moment.iso_8601).diff(moment.utc(),"hours");if(hours<0){hours=0}else if(hours>0&&hours<24){hours=24}var days=(hours/24).toString();if(days=="0"){days="Today"}else if(days=="1"){days="Tomorrow"}else{days="in "+Math.ceil(days)+" days"}$(this).text(days)});$(".season-select select").change(function(){location.href="/show/"+$(this).attr("show-id")+"?season="+$(this).val()});$(".show-info .description .description-text").dotdotdot({after:"a.readmore",tolerance:0,height:70});$(".dropdown-form").click(function(e){e.stopPropagation()});$(".show-list-description-text").dotdotdot({after:"a.readmore",tolerance:0,height:40});$(".play-next").click(function(){var show_id=$(this).attr("show-id");api.get("/api/show-play-next",{show_id:show_id},{done:function(episode){location.href="/show/"+show_id+"/episode/"+episode.number.toString()+"/play"}})});$(".play-next-button").on("touchstart",function(e){e.preventDefault()});$(".show-list-image-tooltip").qtip({content:{text:function(event,api){return $(this).find(".show-tooltip-text").html()},button:true},hide:{delay:isMobile()?0:250,fixed:true,effect:false},show:{effect:false,delay:isMobile()?0:500},position:{adjust:{method:"flip shift"},viewport:$(window),at:"center right",my:"left center"},style:{classes:"show-tooltip",def:false,tip:{width:15,offset:-50}}})});function Api_error(status_code,code,errors,message,extra){this.status_code=status_code;this.code=code;this.errors=errors;this.message=message;this.extra=extra}Api_error.prototype.toString(function(){return this.message+"("+status_code+")"});function Api(){this.defaultErrorCallback=null;this.defaultDoneCallback=null;this.defaultAlwaysCallback=null;this.loaderGif=null}Api.prototype._method=function(url,method,data,callbacks){var _callbacks={done:this.defaultDoneCallback,error:this.defaultErrorCallback,always:this.defaultAlwaysCallback};if(typeof callbacks!=="undefined"){$.extend(_callbacks,callbacks)}headers={"X-XSRFToken":getCookie("_xsrf")};if(this.loaderGif!==null){$(".api_request_loader").html('<img src="'+this.loaderGif+'" />')}$.ajax({url:url,type:method,data:data,headers:headers}).error(function(obj,text_status){if(obj.status>=400&&obj.status<=600){error=new Api_error(obj.status,obj.responseJSON.code,obj.responseJSON.errors,obj.responseJSON.message,obj.responseJSON.extra)}else{error=new Api_error(null,null,null,"can't access the seplis api server",null)}if(_callbacks.error!==null){_callbacks.error(error)}}).done(function(data){if(_callbacks.done!==null){_callbacks.done(data)}}).always(function(){if(this.loaderGif!==null){$(".api_request_loader").empty()}if(_callbacks.always!==null){_callbacks.always(data)}})};Api.prototype.post=function(url,data,callbacks){this._method(url,"POST",data,callbacks)};Api.prototype.get=function(url,data,callbacks){this._method(url,"GET",data,callbacks)};Api.prototype.delete=function(url,data,callbacks){this._method(url,"DELETE",data,callbacks)};function getCookie(name){var r=document.cookie.match("\\b"+name+"=([^;]*)\\b");if(!r&&name=="_xsrf"){return"not_found"}return r?r[1]:undefined}(function(seplisCast,$,undefined){var updateCurrentTimeTimer=null;var updateStoredSessionTimer=null;var currentMediaSession=null;var namespace="urn:x-cast:net.seplis.cast.data";var session=null;var data=null;var castButton=null;onCast=null;onProgress=null;onPlay=null;onPause=null;onReconnected=null;onStopped=null;onLoading=null;seplisCast.init=function(_castButton,appId){castButton=_castButton;startUpdateStoredSessionTimer();setTimeout(function(){if(!chrome.cast||!chrome.cast.isAvailable){console.log("Chrome cast not loaded...")}console.log("init started");var sessionRequest=new chrome.cast.SessionRequest(appId);var apiConfig=new chrome.cast.ApiConfig(sessionRequest,sessionListener,receiverListener,chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED);chrome.cast.initialize(apiConfig,onInitSuccess,onError)},1e3)};seplisCast.isCasting=function(){if(!session)return false;return true};seplisCast.togglePlay=function(){if(!currentMediaSession){play();return}var ps=currentMediaSession.playerState;if(ps=="PLAYING"){if(data.method=="transcode"){stop()}else{currentMediaSession.pause(null,null,onError)}}else if(["PAUSED","IDLE"].indexOf(ps)>=0){if(data.method=="transcode"){play()}else{currentMediaSession.play(null,null,onError)}}};seplisCast.alreadyCasting=function(){if(typeof Storage=="undefined")return false;var storedSession=JSON.parse(localStorage.getItem("storedSession"));if(storedSession){var dateString=storedSession.timestamp;var now=(new Date).getTime();if(now-dateString<36e5)return true}return false};seplisCast.play=function(){play()};seplisCast.deviceName=function(){if(!session)return;return session.receiver.friendlyName};function updateCurrentTime(){if(!session||!currentMediaSession||!data||!currentMediaSession.media){return}currenttime=currentMediaSession.getEstimatedTime();if(data.method=="transcode")currenttime+=data.start_time;if(seplisCast.onProgress)seplisCast.onProgress(currenttime)}function stopApp(){session.stop(onStopAppSuccess,onError);if(updateCurrentTimeTimer){clearInterval(updateCurrentTimeTimer);updateCurrentTimeTimer=null}}function play(){if(seplisCast.onCast==null){console.log("onCast event not set.");return}if(seplisCast.onLoading)seplisCast.onLoading();seplisCast.onCast(function(d){data=d;localStorage.setItem("last_cast_url",window.location.pathname);updateCurrentTime();session.sendMessage(namespace,{method:"setdata",data:data});var mediaInfo=new chrome.cast.media.MediaInfo(data.play_url);mediaInfo.metadata=new chrome.cast.media.GenericMediaMetadata;mediaInfo.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC;mediaInfo.contentType="";var request=new chrome.cast.media.LoadRequest(mediaInfo);session.loadMedia(request,onMediaDiscovered.bind(this,"loadMedia"),onMediaError)})}function receiverMessage(namespace,message){var msg=JSON.parse(message);switch(msg.method){case"setdata":data=msg.data;break}}function onMediaDiscovered(how,mediaSession){mediaSession.addUpdateListener(onMediaStatusUpdate);currentMediaSession=mediaSession}function onMediaError(e){console.log("media error")}function onMediaStatusUpdate(isAlive){if(isAlive){if(currentMediaSession.playerState=="PLAYING"){if(!updateCurrentTimeTimer){updateCurrentTime();updateCurrentTimeTimer=setInterval(updateCurrentTime,1e3);saveSession(session)}if(seplisCast.onPlay)seplisCast.onPlay()}else if(currentMediaSession.playerState=="PAUSED"){if(seplisCast.onPause)seplisCast.onPause()}}else{if(seplisCast.onPause)seplisCast.onPause()}}function onInitSuccess(){console.log("init success")}function onError(e){console.log("Error"+e)}function onSuccess(message){console.log(message)}function onStopAppSuccess(){removeSavedSession()}function sessionListener(e){console.log("New session ID: "+e.sessionId);session=e;saveSession(session);session.addMessageListener(namespace,receiverMessage);if(window.location.pathname!=localStorage.getItem("last_cast_url")){play();return}if(session.media.length!=0){console.log("joining session");onMediaDiscovered("sessionListener",session.media[0]);if(!updateCurrentTimeTimer){updateCurrentTime();updateCurrentTimeTimer=setInterval(updateCurrentTime,1e3);if(seplisCast.onPlay){seplisCast.onPlay()}}}session.addMediaListener(onMediaDiscovered.bind(this,"addMediaListener"));session.addUpdateListener(sessionUpdateListener.bind(this));session.sendMessage(namespace,{method:"getdata"});if(seplisCast.onReconnected)seplisCast.onReconnected()}function sessionUpdateListener(){if(session.status==chrome.cast.SessionStatus.STOPPED){sessionStopped()}else{if(!updateCurrentTimeTimer){updateCurrentTime();updateCurrentTimeTimer=setInterval(updateCurrentTime.bind(this),1e3)}if(seplisCast.onPlay)seplisCast.onPlay()}}function receiverListener(e){if(e==="available"){console.log("receiver found");castButton.css("display","block");castButton.on("click",launchApp)}else{console.log("receiver list empty")}}function launchApp(){console.log("launching app...");chrome.cast.requestSession(onRequestSessionSuccess,onLaunchError)}function onRequestSessionSuccess(e){console.log("session success: "+e.sessionId);session=e;saveSession(session);session.addUpdateListener(sessionUpdateListener.bind(this));if(session.media.length!=0){onMediaDiscovered("onRequestSession",session.media[0])}session.addMediaListener(onMediaDiscovered.bind(this,"addMediaListener"));play()}function onLaunchError(){console.log("Launch error.");removeSavedSession()}function stop(){if(!currentMediaSession)return;currentMediaSession.stop(null,null,onError);if(seplisCast.onPause)seplisCast.onPause();console.log("media stopped");if(updateCurrentTimeTimer){clearInterval(updateCurrentTimeTimer);updateCurrentTimeTimer=null}}function mediaCommandSuccessCallback(info){console.log(info)}function saveSession(session){if(typeof Storage=="undefined")return;var obj={id:session.sessionId,timestamp:(new Date).getTime()};localStorage.setItem("storedSession",JSON.stringify(obj));startUpdateStoredSessionTimer()}function startUpdateStoredSessionTimer(){if(updateStoredSessionTimer)return;updateStoredSessionTimer=setInterval(function(){if(!session){removeSavedSession();clearInterval(updateStoredSessionTimer);updateStoredSessionTimer=null}else{saveSession(session)}},2e3)}function removeSavedSession(){if(typeof Storage=="undefined")return;localStorage.removeItem("storedSession")}function sessionStopped(){session=null;currentMediaSession=null;if(updateCurrentTimeTimer){clearInterval(updateCurrentTimeTimer);updateCurrentTimeTimer=null}removeSavedSession();if(updateStoredSessionTimer){clearInterval(updateStoredSessionTimer);updateStoredSessionTimer=null}if(seplisCast.onPause)seplisCast.onPause();if(seplisCast.onStopped)seplisCast.onStopped();localStorage.removeItem("last_cast_url")}})(window.seplisCast=window.seplisCast||{},jQuery);$(function(){moment.locale("en",{calendar:{lastDay:"[Yesterday] (dddd)",sameDay:"[Today] (dddd)",nextDay:"[Tomorrow] (dddd)",lastWeek:"[Last] dddd",nextWeek:"dddd",sameElse:"dddd"}});$(".airdates date").each(function(){$(this).text(moment.utc($(this).attr("title"),moment.iso_8601).calendar())})});var Template=function(){};Template.prototype.show=function(template,to,data){to.html(_.template(template,data))};$(document).on("click",".btn-fan",function(event){$(this).blur();var _this=this;api.post("/api/fan",$.param({show_id:$(_this).attr("show-id"),"do":"fan"}),{done:function(){var fan_count=$(_this).parent().find(".btn-fan-count");fan_count.html(parseInt(fan_count.html())+1);$(_this).toggleClass("btn-fan btn-unfan")}})});$(document).on("click",".btn-unfan",function(event){$(this).blur();var _this=this;api.post("/api/fan",$.param({show_id:$(_this).attr("show-id"),"do":"unfan"}),{done:function(){var fan_count=$(_this).parent().find(".btn-fan-count");fan_count.html(parseInt(fan_count.html())-1);$(_this).toggleClass("btn-unfan btn-fan")}})});$(document).on("click",".not-watched",function(event){$(this).blur();var btn=$(this);btn.button("loading");api.post("/api/watched",$.param({show_id:btn.attr("show-id"),number:btn.attr("episode-number"),"do":"incr"}),{done:function(){var watched_count=btn.parent().find(".times-watched");watched_count.html(parseInt(watched_count.html())+1);btn.toggleClass("watched not-watched");btn.attr("data-toggle","dropdown")},always:function(){btn.button("reset")}})});$(document).on("click",".watched-button",function(event){$(this).blur();var btn=$(this);if(btn.attr("disabled")){return false}var watched_count=btn.parent().parent().find(".times-watched");var todo=btn.attr("do");if(todo=="decr"&&parseInt(watched_count.html())<=1){todo="delete"}btn.button("loading");api.post("/api/watched",$.param({show_id:btn.attr("show-id"),number:btn.attr("episode-number"),"do":todo}),{done:function(){var count=0;if(btn.attr("do")=="incr"){count=parseInt(watched_count.html())+1}else{count=parseInt(watched_count.html())-1}watched_count.html(count);if(count<=0){var btn_watched=btn.parent().parent().find(".watched");btn_watched.toggleClass("watched not-watched");btn_watched.attr("data-toggle","")}},always:function(){btn.button("reset")}})});$(function(){$("#form-multi-watched").submit(function(event){event.preventDefault();var btn=$(this).find(".btn");btn.button("loading");api.post("/api/watched",$(this).serialize(),{done:function(data){location.reload()},always:function(data){btn.button("reset")}})})});$(function(){$("#sign-in-form").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/sign-in",$(this).serialize(),{done:function(data){location.href=$("#next").val()},always:function(){btn.button("reset")}})});$("#sign-up-form").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/sign-up",$(this).serialize(),{done:function(data){location.href=$("#next").val()},always:function(){btn.button("reset")}})})});(function($){var SeplisPlay=function(video,play_servers,show,episode,start_pos,chromecastAppId,defaultSubtitle,options){var _this=this;var settings=$.extend({},options);var currentPlayServer;var getDevice=function(){var ua=navigator.userAgent.toLowerCase();if(ua.match(/(ipad|iphone)/g)){return"hlsmp4"}return"default"};var guid=function(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return function(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}}();var getCookie=function(name){var r=document.cookie.match("\\b"+name+"=([^;]*)\\b");return r?r[1]:undefined};var session=guid();var device=getDevice();var offsetDuration=0;var lastPosStored=-1;var store_position_every=10;var method="transcode";var startTime=0;var watchedIncremented=false;var duration=0;var metadata;var player;var controlsHideTimer;var enableMousemoveChangeSlider=false;var disableChangeSlider=false;var currentTime;var subtitleLang=defaultSubtitle.subtitle_lang;var audioLang=defaultSubtitle.audio_lang;var playUrl=function(){return _playUrl(method,device,startTime,session)};var _playUrl=function(method,device,starttime,session){var url;startTime=starttime;if(method=="transcode"){url=currentPlayServer.url+"/transcode?play_id="+currentPlayServer.play_id+"&device="+device+"&session="+session+"&start="+starttime.toString();if(subtitleLang){url+="&subtitle_lang="+subtitleLang}if(audioLang){url+="&audio_lang="+audioLang}offsetDuration=starttime}else{url=currentPlayServer.url+"/play?play_id="+currentPlayServer.play_id;if(starttime>0){url=url+"#t="+starttime.toString()}}return url};var setupSubtitles=function(){var subs=[];var audio=[];for(var i in metadata.streams){var stream=metadata.streams[i];if(stream.codec_type=="subtitle"){subs.push(stream.tags.language)}else if(stream.codec_type=="audio"){audio.push(stream.tags.language)}}$(".player-subtitle-select-box").html("");if(subs.length>0||audio.length>1){var subHideTimer=null;$(".player-subtitle-select").show();$(".player-subtitle-select").on("click",function(e){$(".player-subtitle-select-box").toggle()});var html="";html+='<div class="row">';html+='<div class="col-xs-6">';html+="<h4>Audio</h4>";for(var i in audio){html+='<p class="audio-select" lang="'+audio[i]+'">'+audio[i]+"</p>"}html+="</div>";html+='<div class="col-xs-6">';html+="<h4>Subtitles</h4>";html+='<p class="subtitle-select" lang="none">off</p>';for(var i in subs){html+='<p class="subtitle-select" lang="'+subs[i]+'">'+subs[i]+"</p>"}html+="</div>";html+="</div>";$(".player-subtitle-select-box").html(html);$(".subtitle-select, .audio-select").on("click",function(e){var lang=$(this).attr("lang");if($(this).hasClass("subtitle-select")){if(lang=="none"){subtitleLang=null}else{subtitleLang=lang}}else if($(this).hasClass("audio-select")){if(lang=="none"){audioLang=null}else{audioLang=lang}}$.post("/api/user/default-subtitle-show",{show_id:show["id"],subtitle_lang:subtitleLang,audio_lang:audioLang,_xsrf:getCookie("_xsrf")});$(".player-subtitle-select-box").hide();if(!seplisCast.isCasting()){playerPause();playerStart()}else{seplisCast.play()}})}};var changeSlider=function(time){if(disableChangeSlider)return;time=parseInt(time);var norm=$(".player-slider").width()/duration;var dotNorm=$(".player-slider-dot").width()/duration;var x=time*norm;if(x>$(".player-slider").width()){x=$(".player-slider").width()}$(".player-slider-dot").css("left",x-time*dotNorm);$(".player-progress").css("width",x);var t=duration-time;$(".player-timeleft").text(getTimeText(t));currentTime=time};var getTimeText=function(time){var format="mm:ss";if(time>=3600)format="HH:mm:ss";return moment(time*1e3).utc().format(format)};var ChangeVolume=function(volume){var remClases="glyphicon glyphicon-volume-up glyphicon-volume-down glyphicon-volume-off";var icon=$(".player-volume").find("i");icon.removeClass(remClases);if(volume==0||player.muted){icon.addClass("glyphicon glyphicon-volume-off");player.muted=true}else if(volume<=.5){icon.addClass("glyphicon glyphicon-volume-down")}else{icon.addClass("glyphicon glyphicon-volume-up")}$(".player-volume-slider").val(volume);localStorage.setItem("player_volume_default",volume);player.volume=volume};this.setUp=function(metadata_,starttime){metadata=metadata_;startTime=parseInt(starttime);duration=parseInt(metadata["format"]["duration"]).toString();if(isMobile()){$(".player-volume").hide()}if(metadata["format"]["format_name"].indexOf("mp4")>-1){method="play"}player=video.get(0);if(!isMobile())player.volume=localStorage.getItem("player_volume_default")||1;ChangeVolume(player.volume);setupSubtitles();video.on("timeupdate",function(){if(video.attr("src")==undefined)return;ShowPauseButton();$(".player-loading").hide();$(".player-casting-to").hide();var time=offsetDuration+parseInt(this.currentTime);if(time%10==0&&lastPosStored!=time&&time>0&&!watchedIncremented&&startTime/100*10<=duration-startTime){lastPosStored=time;var times=0;if(time/100*10>duration-time){watchedIncremented=true;times=1;time=0}$.post("/api/user/watching",{show_id:show["id"],episode_number:episode["number"],position:time,times:times,_xsrf:getCookie("_xsrf")})}if(!enableMousemoveChangeSlider)changeSlider(time)});video.on("error",function(event){$(".player-play-server-error").show();$(".player-loading").hide()});video.on("pause",function(){if(video.attr("src")==undefined)return;ShowPlayButton();showControls()});video.on("play",function(){if(video.attr("src")==undefined)return;ShowPauseButton();hideErrors();$(".player-loading").show();startHideControlsStartTimer()});video.on("volumechange",function(){ChangeVolume(player.volume)});video.on("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(){var state=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen;if(state){$(".player-fullscreen-button").addClass("hidden");$(".player-windowed-button").removeClass("hidden")}else{$(".player-windowed-button").addClass("hidden");$(".player-fullscreen-button").removeClass("hidden")}startHideControlsStartTimer()});$(window).on("keypress",function(event){if(event.which==32)togglePlay()});$(".player-volume-slider").on("change mousemove touchmove",function(event){ChangeVolume($(this).val());if(event.type=="change")player.muted=false});$(".player-volume i").click(function(){player.muted=!player.muted;if(!player.muted&&player.volume===0){player.volume=1}});$(".player-play-pause-button").click(function(){togglePlay()});$(".player-fullscreen-button").click(function(){if(player.requestFullScreen){player.requestFullScreen()}else if(player.mozRequestFullScreen){player.mozRequestFullScreen()}else if(player.webkitRequestFullScreen){player.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}else if(player.webkitEnterFullscreen){player.webkitEnterFullscreen()}});$(".player-windowed-button").click(function(){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}});$(video).on("mousemove",function(event){showControls();event.stopImmediatePropagation()});$(video).on("click touchstart",function(event){event.stopPropagation();event.preventDefault();if($(".player-back").is(":visible")){if(player.paused||seplisCast.isCasting())return;hideControls()}else{showControls()}});seplisCast.onCast=function(callback){var st=parseInt(currentTime);playerPause();setTimeout(showCastingScreen,500);if(method=="transcode"){if(device=="hlsmp4")$.get(currentPlayServer.url+"/"+session+"/cancel")}api.get("/api/progress-token",null,{done:function(data){callback({show:show,episode:episode,start_time:st,token:data.token,play_url:_playUrl(method,"default",st,guid()),method:method,duration:parseInt(duration),api_url:data["api_url"],user_id:data["user_id"]})}})};seplisCast.onProgress=function(currenttime){if(enableMousemoveChangeSlider)return;if(currenttime==0)return;disableChangeSlider=false;startTime=currenttime|0;offsetDuration=0;changeSlider(currenttime);$(".player-casting-to").show();hideErrors()};seplisCast.onPlay=function(){ShowPauseButton();enableMousemoveChangeSlider=false;disableChangeSlider=false};seplisCast.onPause=function(){ShowPlayButton()};seplisCast.onReconnected=function(){player.pause();setTimeout(showCastingScreen,100)};seplisCast.onStopped=function(){$(".player-casting-to").hide()};seplisCast.onLoading=function(){ShowPauseButton();$(".player-loading").show()};seplisCast.init($(".player-cast"),chromecastAppId);changeSlider(startTime);if(!seplisCast.alreadyCasting()){video.attr("src",playUrl())}else{showCastingScreen();hideControls();$(".player-back").show();setTimeout(function(){if(!seplisCast.isCasting()){playerStart();showControls();$(".player-loading").hide();$(".player-casting-to").hide()}},2e3)}HlsPing()};var showCastingScreen=function(){showControls();if(video.attr("src")!=undefined)video.attr("src",undefined);$(".player-casting-to").show();$(".casting-to-name").text(seplisCast.deviceName());clearTimeout(controlsHideTimer)};var ShowPauseButton=function(){$(".player-pause-button").removeClass("hidden");$(".player-play-button").addClass("hidden")};var ShowPlayButton=function(){$(".player-play-button").removeClass("hidden");$(".player-pause-button").addClass("hidden")};var startHideControlsStartTimer=function(){clearTimeout(controlsHideTimer);controlsHideTimer=setTimeout(function(){if(player.paused||seplisCast.isCasting())return;hideControls()},3e3)};var hideControls=function(){clearTimeout(controlsHideTimer);$(".player-controls-wrapper").css("visibility","hidden");$(".player-slider-time").css("visibility","hidden");$(".player-back").hide();$(".player-subtitle-select-box").hide()};var showControls=function(){startHideControlsStartTimer();$(".player-controls-wrapper").css("visibility","visible");$(".player-back").show()};$(".player-controls-wrapper").on("mouseenter",function(){clearTimeout(controlsHideTimer)});$(".player-controls-wrapper").on("mouseleave",function(event){startHideControlsStartTimer()});$(".player-back").on("click",function(){location.href="/show/"+show["id"]});var playerPause=function(){if(player.paused===true)return;player.pause();if(method=="transcode"){if(device=="hlsmp4")$.get(currentPlayServer.url+"/"+session+"/cancel");startTime=parseInt(player.currentTime+offsetDuration)}};var playerStart=function(){$(".player-loading").show();if(method=="transcode"||video.attr("src")==undefined)video.attr("src",playUrl());if(device=="hlsmp4"&&method=="transcode"){setTimeout(function(){player.play()},1e3)}else{player.play()}};var togglePlay=function(){if(!seplisCast.isCasting()){if(!player.paused&&player.readyState!=0){playerPause()}else{playerStart()}}else{seplisCast.togglePlay()}};var startAtSliderPos=function(event){var x=getEventXOffset(event);if(x<0)return;var norm=duration/$(".player-slider").width();var time=x*norm;time=parseInt(time);changeSlider(time);if(seplisCast.isCasting()){disableChangeSlider=true;startTime=time;session=guid();seplisCast.play()}else{if(method=="play"){player.currentTime=time}else{if(player.paused===false)togglePlay();startTime=time;session=guid();togglePlay()}}};var getEventXOffset=function(event){if(event.type.match("^touch")){event=event.originalEvent.touches[0]||event.originalEvent.changedTouches[0]}var x=event.clientX-$(".player-slider").offset().left;if(x>$(".player-slider").width())x=$(".player-slider").width();return x};$(".player-slider").click(function(event){startAtSliderPos(event)});$(window).resize(function(){changeSlider(currentTime)});$(".player-slider").on("mousedown touchstart",function(event){enableMousemoveChangeSlider=true;disableChangeSlider=false;if(event.type=="touchstart")clearTimeout(controlsHideTimer)});$(".player-slider").on("mousemove touchmove",function(event){event.stopPropagation();event.preventDefault();$(".player-slider-time").css("visibility","visible");var x=getEventXOffset(event);if(x<0)return;var norm=duration/$(".player-slider").width();$(".player-slider-time").css("left",x-$(".player-slider-time").outerWidth()/2);$(".player-slider-time").text(getTimeText(norm*x));if(enableMousemoveChangeSlider)changeSlider(norm*x)});$(document).on("mouseup",function(){enableMousemoveChangeSlider=false});$(".player-slider").on("touchend",function(event){startHideControlsStartTimer();enableMousemoveChangeSlider=false;startAtSliderPos(event);$(".player-slider-time").css("visibility","hidden")});$(".player-slider").on("mouseleave",function(){$(".player-slider-time").css("visibility","hidden")});var HlsPing=function(){if(device!="hlsmp4")return;if(player.paused===false){$.get(currentPlayServer.url+"/"+session+"/ping")}setTimeout(function(){HlsPing()},5e3)};var hideErrors=function(){$(".player-episode-404").hide();$(".player-play-server-error").hide();$(".player-loading").hide()};var checkServer=function(play_server){hideErrors();$(".player-loading").show();$.getJSON(play_server.url+"/metadata",{play_id:play_server.play_id},function(data){if(currentPlayServer)return;hideErrors();currentPlayServer=play_server;_this.setUp(data,start_pos);player.play()}).error(function(jqxhr,textStatus,error){if(currentPlayServer)return;if(jqxhr.status==404){$(".player-episode-404").show()}else{$(".player-play-server-error").show()}$(".player-loading").hide()})};for(i in play_servers){var ps=play_servers[i];if(ps.url.substr(ps.url.length-1)=="/"){ps.url=ps.url.substr(0,ps.url.length-1)}checkServer(ps)}};$.fn.seplis_play=function(play_servers,show,episode,start_pos,chromecastAppId,defaultSubtitle,options){return this.each(function(){var video=$(this);if(video.data("seplis_play"))return;var seplis_play=new SeplisPlay(video,play_servers,show,episode,start_pos,chromecastAppId,defaultSubtitle,options);video.data("seplis_play",seplis_play)})}})(jQuery);String.prototype.endsWith=function(suffix){return this.indexOf(suffix,this.length-suffix.length)!==-1};var isMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)};$(function(){$(".autocomplete-show").autocomplete({serviceUrl:"/api/suggest",paramName:"q",noCache:true,width:400,triggerSelectOnValidInput:false,transformResult:function(response){response=$.parseJSON(response);return{suggestions:$.map(response,function(r){return{value:r.title.toString(),data:r}})}},formatResult:function(suggestion,currentValue){return _.template('<div class="show-suggest">'+'<span class="image"><img src="<% if (poster_image && poster_image.url) { %><%= poster_image.url %>@SX60<% } %>" width="60px" height="88px"></span>'+'<span class="text"><strong><%- title %></strong> '+"<% if (premiered) { %>"+"(<%- premiered.substring(0, 4) %>)"+"<% } %>"+"</span>"+"</div>",suggestion.data)},onSelect:function(suggestion){location.href="/show/"+suggestion.data.id}});$(".change-page").change(function(){var url=$.url(location.href);p=url.param();p["page"]=$(this).val();location.href=url.attr("path")+"?"+$.param(p)});$(".change-layout").click(function(event){event.preventDefault();$.cookie("layout",$(this).attr("data-layout"),{expires:1*365});location.reload()});$(document).on("hidden.bs.modal","#seplis-modal",function(e){var obj=$(e.target).removeData("bs.modal").find(".modal-content");obj.empty()})});$(".add-show-tag").submit(function(event){event.preventDefault();api.post("/user-tags",$(this).serialize(),{done:function(data){alert(data)}})});$(document).on("submit",".form-tag",function(event){event.preventDefault();var _this=this;var relation_id=$(_this).find(".tag-relation-id").val();api.post("/user-tags",$(this).serialize(),{done:function(data){api.get("/user-tags",$(_this).serialize(),{done:function(data){show_tags($("#tags-"+relation_id),data,relation_id)}});$(_this).find('input[name="name"]').val("");$(document).click()}})});$(".btn-add-tag").click(function(){var _this=this;setInterval(function(){$(_this).parent().find(".input-add-tag").focus()},10)});$(".btn-group").on("click",".link-tag-delete",function(event){event.preventDefault();$(this).parent().find(".form-tag").submit()});function tag_generate_html(tag,relation_id){return _.template(multiline(function(){}),{tag:tag,relation_id:relation_id,current_user:current_user})}function show_tags(obj,tags,relation_id){obj.children(".btn-group").slice(1).remove();if(tags.length===0){obj.append(multiline(function(){}));return}$.each(tags,function(index,tag){obj.append(tag_generate_html(tag,relation_id))})}$(function(){$("#form-play-server").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/user/play-server",$(this).serialize(),{done:function(data){location.href="/user/play-servers"},always:function(){btn.button("reset")}})});$("#button-play-server-delete").click(function(event){event.preventDefault();if(!confirm("Sure you wan't to delete this play server?")){return}var btn=$(this);btn.button("loading");api.delete("/api/user/play-server",{id:$(this).attr("play-server-id")},{done:function(data){location.href="/user/play-servers"},always:function(){btn.button("reset")}})});$(".episode-play-servers").click(function(){var menu=$(this).parent().find(".dropdown-menu");api.get("/api/show-episode/play-servers",{show_id:$(this).attr("show-id"),episode_number:$(this).attr("episode-number")},{done:function(data){menu.html(_.template("<% for (var ps in play_servers) { %>"+"<li>"+"<a "+'href="/play-episode?play_server_id=<%- play_servers[ps].play_server.id %>&play_id=<%- play_servers[ps].play_id %>"'+">"+"<%- play_servers[ps].play_server.name %>"+"</a>"+"</li>"+"<% } %>",{play_servers:data}))}})});$("#playserver-autocomplete-user").autocomplete({serviceUrl:"/api/users",paramName:"q",noCache:true,width:200,triggerSelectOnValidInput:false,transformResult:function(response){response=$.parseJSON(response);return{suggestions:$.map(response,function(r){return{value:r.name.toString(),data:r}})}},formatResult:function(suggestion,currentValue){return _.template('<div class="user-suggest">'+'<span class="text">'+"<%- name %>"+"</span>"+"</div>",suggestion.data)},onSelect:function(data){api.post("/api/user/play-server/user",{server_id:$("#playserver-autocomplete-user").attr("server-id"),user_id:data.data.id},{done:function(data){location.reload()}})}});$(".play-server-remove-user").click(function(){api.delete("/api/user/play-server/user",{user_id:$(this).attr("user-id"),server_id:$(this).attr("server-id")},{done:function(){location.reload()}})})});