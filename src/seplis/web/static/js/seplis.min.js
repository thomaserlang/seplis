function Api_error(status_code,code,errors,message,extra){this.status_code=status_code;this.code=code;this.errors=errors;this.message=message;this.extra=extra}Api_error.prototype.toString(function(){return this.message+"("+status_code+")"});function Api(){this.defaultErrorCallback=null;this.defaultDoneCallback=null;this.defaultAlwaysCallback=null;this.loaderGif=null}Api.prototype._method=function(url,method,data,callbacks){var _callbacks={done:this.defaultDoneCallback,error:this.defaultErrorCallback,always:this.defaultAlwaysCallback};if(typeof callbacks!=="undefined"){$.extend(_callbacks,callbacks)}headers={"X-XSRFToken":getCookie("_xsrf")};if(this.loaderGif!==null){$(".api_request_loader").html('<img src="'+this.loaderGif+'" />')}$.ajax({url:url,type:method,data:data,headers:headers}).error(function(obj,text_status){if(obj.status>=400&&obj.status<=600){error=new Api_error(obj.status,obj.responseJSON.code,obj.responseJSON.errors,obj.responseJSON.message,obj.responseJSON.extra)}else{error=new Api_error(null,null,null,"can't access the seplis api server",null)}if(_callbacks.error!==null){_callbacks.error(error)}}).done(function(data){if(_callbacks.done!==null){_callbacks.done(data)}}).always(function(){if(this.loaderGif!==null){$(".api_request_loader").empty()}if(_callbacks.always!==null){_callbacks.always(data)}})};Api.prototype.post=function(url,data,callbacks){this._method(url,"POST",data,callbacks)};Api.prototype.get=function(url,data,callbacks){this._method(url,"GET",data,callbacks)};Api.prototype.delete=function(url,data,callbacks){this._method(url,"DELETE",data,callbacks)};function getCookie(name){var r=document.cookie.match("\\b"+name+"=([^;]*)\\b");if(!r&&name=="_xsrf"){return"not_found"}return r?r[1]:undefined}$(".add-show-tag").submit(function(event){event.preventDefault();api.post("/user-tags",$(this).serialize(),{done:function(data){alert(data)}})});$(document).on("submit",".form-tag",function(event){event.preventDefault();var _this=this;var relation_id=$(_this).find(".tag-relation-id").val();api.post("/user-tags",$(this).serialize(),{done:function(data){api.get("/user-tags",$(_this).serialize(),{done:function(data){show_tags($("#tags-"+relation_id),data,relation_id)}});$(_this).find('input[name="name"]').val("");$(document).click()}})});$(".btn-add-tag").click(function(){var _this=this;setInterval(function(){$(_this).parent().find(".input-add-tag").focus()},10)});$(".btn-group").on("click",".link-tag-delete",function(event){event.preventDefault();$(this).parent().find(".form-tag").submit()});function tag_generate_html(tag,relation_id){return _.template(multiline(function(){}),{tag:tag,relation_id:relation_id,current_user:current_user})}function show_tags(obj,tags,relation_id){obj.children(".btn-group").slice(1).remove();if(tags.length===0){obj.append(multiline(function(){}));return}$.each(tags,function(index,tag){obj.append(tag_generate_html(tag,relation_id))})}String.prototype.endsWith=function(suffix){return this.indexOf(suffix,this.length-suffix.length)!==-1};var isMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)};$(function(){$(".autocomplete").autocomplete({serviceUrl:"/api/suggest",paramName:"q",noCache:true,width:400,triggerSelectOnValidInput:false,transformResult:function(response){response=$.parseJSON(response);return{suggestions:$.map(response,function(r){return{value:r.title.toString(),data:r}})}},formatResult:function(suggestion,currentValue){return _.template('<div class="show-suggest">'+'<span class="image"><img src="<% if (poster_image && poster_image.url) { %><%= poster_image.url %>@SX60<% } %>" width="60px" height="88px"></span>'+'<span class="text"><strong><%- title %></strong> '+"<% if (premiered) { %>"+"(<%- premiered.substring(0, 4) %>)"+"<% } %>"+"</span>"+"</div>",suggestion.data)},onSelect:function(suggestion){location.href="/show/"+suggestion.data.id}});$(".change-page").change(function(){var url=$.url(location.href);p=url.param();p["page"]=$(this).val();location.href=url.attr("path")+"?"+$.param(p)});$(".change-layout").click(function(event){event.preventDefault();$.cookie("layout",$(this).attr("data-layout"),{expires:1*365});location.reload()});$(document).on("hidden.bs.modal","#seplis-modal",function(e){var obj=$(e.target).removeData("bs.modal").find(".modal-content");obj.empty()})});$(function(){moment.locale("en",{calendar:{lastDay:"[Yesterday] (dddd)",sameDay:"[Today] (dddd)",nextDay:"[Tomorrow] (dddd)",lastWeek:"[Last] dddd",nextWeek:"dddd",sameElse:"dddd"}});$(".airdates date").each(function(){$(this).text(moment.utc($(this).attr("title"),moment.iso_8601).calendar())});$(".airdate-show-image").qtip({content:{text:function(event,api){return $(this).find(".airdate-show-tooltip").html()},button:true},hide:{delay:isMobile()?0:250,fixed:true,effect:false},show:{effect:false,delay:isMobile()?0:500},position:{adjust:{method:"flip shift"},viewport:$(window),at:"center right",my:"left center"},style:{classes:"show-tooltip",def:false,tip:{width:15,offset:-50}}})});$(function(){$("#form-new-show").submit(function(event){event.preventDefault();api.post("/api/show-new",$(this).serialize(),{done:function(data){location.href="/show/"+data["id"]}})});$("#form-edit-show").submit(function(event){event.preventDefault();api.post("/api/show-edit/"+$(this).attr("show-id"),$(this).serialize(),{done:function(data){$.growl({title:"Success!",message:"The show has been updated.",location:"tc"})}})});if($("#alternative-titles").length){$("#alternative-titles").select2({tags:[]})}$("date.show-date").each(function(){var hours=moment.utc($(this).attr("title"),moment.iso_8601).diff(moment.utc(),"hours");if(hours<0){hours=0}else if(hours>0&&hours<24){hours=24}var days=(hours/24).toString();if(days=="0"){days="Today"}else if(days=="1"){days="Tomorrow"}else{days="in "+Math.ceil(days)+" days"}$(this).text(days)});$(".season-select select").change(function(){location.href="/show/"+$(this).attr("show-id")+"?season="+$(this).val()});$(".show-info .description .description-text").dotdotdot({after:"a.readmore",tolerance:0,height:70});$(".dropdown-form").click(function(e){e.stopPropagation()});$(".show-list-description-text").dotdotdot({after:"a.readmore",tolerance:0,height:40});$(".play-next-button").click(function(){var show_id=$(this).attr("show-id");api.get("/api/show-play-next",{show_id:show_id},{done:function(episode){location.href="/show/"+show_id+"/episode/"+episode.number.toString()+"/play"}})})});function get_show_play_next(show_id){$("#show-play-next-image").attr("data-target","").attr("href","");api.get("/api/show-play-next",{show_id:show_id},{done:function(episode){$("#show-play-next-image").attr("data-target","#seplis-modal").attr("href","/modal/play-episode?show_id="+show_id+"&episode_number="+episode.number)}})}(function($){var SeplisPlay=function(video,play_servers,show_id,episode_number,start_pos,options){var _this=this;var settings=$.extend({},options);var currentPlayServer;var getDevice=function(){var ua=navigator.userAgent;if(ua.match(/(iPad|iPhone|iPod)/g)){return"hlsmp4"}return"default"};var guid=function(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return function(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}}();var getCookie=function(name){var r=document.cookie.match("\\b"+name+"=([^;]*)\\b");return r?r[1]:undefined};var session=guid();var device=getDevice();var offsetDuration=0;var lastPosStored=-1;var store_position_every=10;var method="transcode";var startTime=0;var watchedIncremented=false;var duration=0;var metadata;var player;var controlsHideTimer;var playUrl=function(){var url;if(method=="transcode"){url=currentPlayServer.url+"/transcode?play_id="+currentPlayServer.play_id+"&device="+device+"&session="+session+"&start="+startTime.toString();offsetDuration=startTime}else{url=currentPlayServer.url+"/play?play_id="+currentPlayServer.play_id;if(startTime>0){url=url+"#t="+startTime.toString()}}return url};var changeSlider=function(time){time=parseInt(time);var norm=$(".player-slider").width()/duration;var dotNorm=$(".player-slider-dot").width()/duration;$(".player-slider-dot").css("left",time*norm-time*dotNorm);$(".player-progress").css("width",time*norm);var format="mm:ss";var t=duration-time;if(t>=3600)format="hh:mm:ss";$(".player-timeleft").html(moment(t*1e3).format(format))};var ChangeVolume=function(volume){var remClases="glyphicon glyphicon-volume-up glyphicon-volume-down glyphicon-volume-off";var icon=$(".player-volume").find("i");icon.removeClass(remClases);if(volume==0||player.muted){icon.addClass("glyphicon glyphicon-volume-off");player.muted=true}else if(volume<=.5){icon.addClass("glyphicon glyphicon-volume-down")}else{icon.addClass("glyphicon glyphicon-volume-up")}$(".player-volume-slider").val(volume);localStorage.setItem("player_volume_default",volume);player.volume=volume};this.setUp=function(metadata_,starttime){metadata=metadata_;startTime=parseInt(starttime);duration=parseInt(metadata["format"]["duration"]).toString();if(isMobile()){$(".player-volume").hide()}if(metadata["format"]["format_name"].indexOf("mp4")>-1){method="play"}player=video.get(0);if(!isMobile())player.volume=localStorage.getItem("player_volume_default")||1;ChangeVolume(player.volume);video.on("timeupdate",function(){$(".player-loading").hide();var time=offsetDuration+parseInt(this.currentTime);if(time%10==0&&lastPosStored!=time&&time>0&&!watchedIncremented){lastPosStored=time;var times=0;if(time/100*10>duration-time){watchedIncremented=true;times=1;time=0}$.post("/api/user/watching",{show_id:show_id,episode_number:episode_number,position:time,times:times,_xsrf:getCookie("_xsrf")})}changeSlider(time)});video.on("error",function(event){$(".player-play-server-error").show();$(".player-loading").hide()});video.on("pause",function(){$(".player-play-button").removeClass("hidden");$(".player-pause-button").addClass("hidden");showControls()});video.on("play",function(){$(".player-pause-button").removeClass("hidden");$(".player-play-button").addClass("hidden");hideErrors()});video.on("volumechange",function(){ChangeVolume(player.volume)});video.on("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(){var state=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen;if(state){$(".player-fullscreen-button").addClass("hidden");$(".player-windowed-button").removeClass("hidden")}else{$(".player-windowed-button").addClass("hidden");$(".player-fullscreen-button").removeClass("hidden")}startHideControlsStartTimer()});$(window).on("keypress",function(event){console.log(event.which);if(event.which==32)togglePlay()});$(".player-volume-slider").on("change mousemove touchmove",function(event){ChangeVolume($(this).val());if(event.type=="change")player.muted=false});$(".player-volume i").click(function(){player.muted=!player.muted;if(!player.muted&&player.volume===0){player.volume=1}});$(".player-play-pause-button").click(function(){togglePlay()});$(".player-fullscreen-button").click(function(){if(player.requestFullScreen){player.requestFullScreen()}else if(player.mozRequestFullScreen){player.mozRequestFullScreen()}else if(player.webkitRequestFullScreen){player.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}else if(player.webkitEnterFullscreen){player.webkitEnterFullscreen()}});$(".player-windowed-button").click(function(){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}});$(".player-slider").click(function(event){console.log($(".player-controls-wrapper").css("visibility"));var norm=duration/$(".player-slider").width();var time=(event.pageX-$(this).offset().left)*norm;time=parseInt(time);changeSlider(time);if(method=="play"){player.currentTime=time}else{if(player.paused===false)togglePlay();startTime=time;session=guid();watchedIncremented=false;togglePlay()}});$(video).on("mousemove",function(event){showControls();event.stopImmediatePropagation()});$(video).on("click",function(event){if($(".player-back").is(":visible")){if(player.paused===true)return;hideControls()}else{showControls()}});startHideControlsStartTimer();changeSlider(startTime);var url=playUrl();video.attr("src",url);video.load()};var startHideControlsStartTimer=function(){clearTimeout(controlsHideTimer);controlsHideTimer=setTimeout(function(){if(player.paused)return;hideControls()},3e3)};var hideControls=function(){clearTimeout(controlsHideTimer);$(".player-controls-wrapper").css("visibility","hidden");$(".player-back").hide()};var showControls=function(){startHideControlsStartTimer();$(".player-controls-wrapper").css("visibility","visible");$(".player-back").show()};$(".player-back").on("click",function(){location.href="/show/"+show_id});var togglePlay=function(){if(player.paused===false){player.pause();if(method=="transcode"){$.get(currentPlayServer.url+"/"+session+"/cancel");startTime=parseInt(player.currentTime+offsetDuration)}}else{$(".player-loading").show();if(method=="transcode")video.attr("src",playUrl());if(device=="hlsmp4"&&method=="transcode"){setTimeout(function(){player.play()},1e3)}else{player.play()}}};var hideErrors=function(){$(".player-episode-404").hide();$(".player-play-server-error").hide();$(".player-loading").hide()};var checkServer=function(play_server){$(".player-episode-404").hide();$(".player-play-server-error").hide();$(".player-loading").show();$.getJSON(play_server.url+"/metadata",{play_id:play_server.play_id},function(data){if(currentPlayServer)return;hideErrors();currentPlayServer=play_server;_this.setUp(data,start_pos);player.play()}).error(function(jqxhr,textStatus,error){if(currentPlayServer)return;if(jqxhr.status==404){$(".player-episode-404").show()}else{$(".player-play-server-error").show()}$(".player-loading").hide()})};for(i in play_servers){var ps=play_servers[i];if(ps.url.substr(ps.url.length-1)=="/"){ps.url=ps.url.substr(0,ps.url.length-1)}checkServer(ps)}};$.fn.seplis_play=function(play_servers,show_id,episode_number,start_pos,options){return this.each(function(){var video=$(this);if(video.data("seplis_play"))return;var seplis_play=new SeplisPlay(video,play_servers,show_id,episode_number,start_pos,options);video.data("seplis_play",seplis_play)})}})(jQuery);$(function(){$("#sign-in-form").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/sign-in",$(this).serialize(),{done:function(data){location.href=$("#next").val()},always:function(){btn.button("reset")}})});$("#sign-up-form").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/sign-up",$(this).serialize(),{done:function(data){location.href=$("#next").val()},always:function(){btn.button("reset")}})})});var Template=function(){};Template.prototype.show=function(template,to,data){to.html(_.template(template,data))};$(document).on("click",".btn-fan",function(event){$(this).blur();var _this=this;api.post("/api/fan",$.param({show_id:$(_this).attr("show-id"),"do":"fan"}),{done:function(){var fan_count=$(_this).parent().find(".btn-fan-count");fan_count.html(parseInt(fan_count.html())+1);$(_this).toggleClass("btn-fan btn-unfan")}})});$(document).on("click",".btn-unfan",function(event){$(this).blur();var _this=this;api.post("/api/fan",$.param({show_id:$(_this).attr("show-id"),"do":"unfan"}),{done:function(){var fan_count=$(_this).parent().find(".btn-fan-count");fan_count.html(parseInt(fan_count.html())-1);$(_this).toggleClass("btn-unfan btn-fan")}})});$(document).on("click",".not-watched",function(event){$(this).blur();var btn=$(this);btn.button("loading");api.post("/api/watched",$.param({show_id:btn.attr("show-id"),number:btn.attr("episode-number"),"do":"incr"}),{done:function(){var watched_count=btn.parent().find(".times-watched");watched_count.html(parseInt(watched_count.html())+1);btn.toggleClass("watched not-watched");btn.attr("data-toggle","dropdown")},always:function(){btn.button("reset")}})});$(document).on("click",".watched-button",function(event){$(this).blur();var btn=$(this);if(btn.attr("disabled")){return false}var watched_count=btn.parent().parent().find(".times-watched");var todo=btn.attr("do");if(todo=="decr"&&parseInt(watched_count.html())<=1){todo="delete"}btn.button("loading");api.post("/api/watched",$.param({show_id:btn.attr("show-id"),number:btn.attr("episode-number"),"do":todo}),{done:function(){var count=0;if(btn.attr("do")=="incr"){count=parseInt(watched_count.html())+1}else{count=parseInt(watched_count.html())-1}watched_count.html(count);if(count<=0){var btn_watched=btn.parent().parent().find(".watched");btn_watched.toggleClass("watched not-watched");btn_watched.attr("data-toggle","")}},always:function(){btn.button("reset")}})});$(function(){$("#form-multi-watched").submit(function(event){event.preventDefault();var btn=$(this).find(".btn");btn.button("loading");api.post("/api/watched",$(this).serialize(),{done:function(data){location.reload()},always:function(data){btn.button("reset")}})})});$(function(){$("#form-play-server").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/user/play-server",$(this).serialize(),{done:function(data){location.href="/user/play-servers"},always:function(){btn.button("reset")}})});$("#button-play-server-delete").click(function(event){event.preventDefault();if(!confirm("Sure you wan't to delete this play server?")){return}var btn=$(this);btn.button("loading");api.delete("/api/user/play-server",{id:$(this).attr("play-server-id")},{done:function(data){location.href="/user/play-servers"},always:function(){btn.button("reset")}})});$(".episode-play-servers").click(function(){var menu=$(this).parent().find(".dropdown-menu");api.get("/api/show-episode/play-servers",{show_id:$(this).attr("show-id"),episode_number:$(this).attr("episode-number")},{done:function(data){menu.html(_.template("<% for (var ps in play_servers) { %>"+"<li>"+"<a "+'href="/play-episode?play_server_id=<%- play_servers[ps].play_server.id %>&play_id=<%- play_servers[ps].play_id %>"'+">"+"<%- play_servers[ps].play_server.name %>"+"</a>"+"</li>"+"<% } %>",{play_servers:data}))}})})});