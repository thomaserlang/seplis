function Api_error(status_code,code,errors,message,extra){this.status_code=status_code;this.code=code;this.errors=errors;this.message=message;this.extra=extra}Api_error.prototype.toString(function(){return this.message+"("+status_code+")"});function Api(){this.default_error_callback=null;this.loader_gif=null}Api.prototype._method=function(url,method,data,callbacks){var _callbacks={done:null,error:this.default_error_callback,always:null};if(typeof callbacks!=="undefined"){$.extend(_callbacks,callbacks)}headers={"X-XSRFToken":getCookie("_xsrf")};if(this.loader_gif!==null){$(".api_request_loader").html('<img src="'+this.loader_gif+'" />')}$.ajax({url:url,type:method,data:data,headers:headers}).error(function(obj,text_status){if(obj.status>=400&&obj.status<=600){error=new Api_error(obj.status,obj.responseJSON.code,obj.responseJSON.errors,obj.responseJSON.message,obj.responseJSON.extra)}else{error=new Api_error(null,null,null,"can't access the seplis api server",null)}if(_callbacks.error!==null){_callbacks.error(error)}}).done(function(data){if(_callbacks.done!==null){_callbacks.done(data)}}).always(function(){if(this.loader_gif!==null){$(".api_request_loader").empty()}if(_callbacks.always!==null){_callbacks.always(data)}})};Api.prototype.post=function(url,data,callbacks){this._method(url,"POST",data,callbacks)};Api.prototype.get=function(url,data,callbacks){this._method(url,"GET",data,callbacks)};Api.prototype.delete=function(url,data,callbacks){this._method(url,"DELETE",data,callbacks)};function getCookie(name){var r=document.cookie.match("\\b"+name+"=([^;]*)\\b");if(!r&&name=="_xsrf"){return"not_found"}return r?r[1]:undefined}$(".add-show-tag").submit(function(event){event.preventDefault();api.post("/user-tags",$(this).serialize(),{done:function(data){alert(data)}})});$(document).on("submit",".form-tag",function(event){event.preventDefault();var _this=this;var relation_id=$(_this).find(".tag-relation-id").val();api.post("/user-tags",$(this).serialize(),{done:function(data){api.get("/user-tags",$(_this).serialize(),{done:function(data){show_tags($("#tags-"+relation_id),data,relation_id)}});$(_this).find('input[name="name"]').val("");$(document).click()}})});$(".btn-add-tag").click(function(){var _this=this;setInterval(function(){$(_this).parent().find(".input-add-tag").focus()},10)});$(".btn-group").on("click",".link-tag-delete",function(event){event.preventDefault();$(this).parent().find(".form-tag").submit()});function tag_generate_html(tag,relation_id){return _.template(multiline(function(){}),{tag:tag,relation_id:relation_id,current_user:current_user})}function show_tags(obj,tags,relation_id){obj.children(".btn-group").slice(1).remove();if(tags.length===0){obj.append(multiline(function(){}));return}$.each(tags,function(index,tag){obj.append(tag_generate_html(tag,relation_id))})}String.prototype.endsWith=function(suffix){return this.indexOf(suffix,this.length-suffix.length)!==-1};$(function(){$(".autocomplete").autocomplete({serviceUrl:"/api/suggest",paramName:"q",noCache:true,width:400,triggerSelectOnValidInput:false,transformResult:function(response){response=$.parseJSON(response);return{suggestions:$.map(response,function(r){return{value:r.title.toString(),data:r}})}},formatResult:function(suggestion,currentValue){return _.template('<div class="show-suggest">'+'<span class="image"><img src="<%- poster_image.url %>@SX60" width="60"></span>'+'<span class="text"><strong><%- title %></strong> (<%- premiered.substring(0, 4) %>)</span>'+"</div>",suggestion.data)},onSelect:function(suggestion){location.href="/show/"+suggestion.data.id}});$(".change-page").change(function(){var url=$.url(location.href);p=url.param();p["page"]=$(this).val();location.href=url.attr("path")+"?"+$.param(p)});$(".change-layout").click(function(event){event.preventDefault();$.cookie("layout",$(this).attr("data-layout"),{expires:1*365});location.reload()});$(document).on("hidden.bs.modal","#seplis-modal",function(e){var obj=$(e.target).removeData("bs.modal").find(".modal-content");obj.empty()})});$(function(){moment.locale("en",{calendar:{lastDay:"[Yesterday] (dddd)",sameDay:"[Today] (dddd)",nextDay:"[Tomorrow] (dddd)",lastWeek:"[Last] dddd",nextWeek:"dddd",sameElse:"dddd"}});$(".airdates date").each(function(){$(this).text(moment.utc($(this).attr("title"),moment.iso_8601).calendar())})});$(function(){$("#form-new-show").submit(function(event){event.preventDefault();api.post("/api/show-new",$(this).serialize(),{done:function(data){location.href="/show/"+data["id"]}})});$("#form-edit-show").submit(function(event){event.preventDefault();api.post("/api/show-edit/"+$(this).attr("show-id"),$(this).serialize(),{done:function(data){$.growl({title:"Success!",message:"The show has been updated.",location:"tc"})}})});if($("#alternative-titles").length){$("#alternative-titles").select2({tags:[]})}$("date.show-date").each(function(){var hours=moment.utc($(this).attr("title"),moment.iso_8601).diff(moment.utc(),"hours");if(hours<0){hours=0}else if(hours>0&&hours<24){hours=24}var days=(hours/24).toString();if(days=="0"){days="Today"}else if(days=="1"){days="Tomorrow"}else{days="in "+Math.ceil(days)+" days"}$(this).text(days)});$(".season-select select").change(function(){location.href="/show/"+$(this).attr("show-id")+"?season="+$(this).val()});$(".show-info .description .description-text").dotdotdot({after:"a.readmore",tolerance:0,height:70});$(".dropdown-form input, .dropdown-form label, .dropdown-form .btn").click(function(e){e.stopPropagation()});$(".show-list-description-text").dotdotdot({after:"a.readmore",tolerance:0,height:40})});function get_show_play_next(show_id){$("#show-play-next-image").attr("data-target","").attr("href","");api.get("/api/show-play-next",{show_id:show_id},{done:function(episode){$("#show-play-next-image").attr("data-target","#seplis-modal").attr("href","/modal/play-episode?show_id="+show_id+"&episode_number="+episode.number)}})}(function($){var SeplisPlay=function(video,play_servers,show_id,episode_number,start_pos,options){var _this=this;var settings=$.extend({},options);this.currentPlayServer=null;this.getDevice=function(){if(navigator.userAgent.match(/(iPad|iPhone|iPod)/g)){return"apple"}return"default"};var guid=function(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return function(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}}();var getCookie=function(name){var r=document.cookie.match("\\b"+name+"=([^;]*)\\b");return r?r[1]:undefined};var session=guid();var device=this.getDevice();var offset_duration=0;var stop_duration_update=false;var latest_position_stored=-1;var store_position_every=10;var method="transcode";var startTime=0;var watchedIncremented=false;var duration=0;this.setStart=function(startime){startTime=startime;if(method=="transcode"){var url=_this.currentPlayServer.url+"/transcode?play_id="+_this.currentPlayServer.play_id+"&device="+device+"&session="+session+"&start="+startime.toString();offset_duration=startime}else{var url=_this.currentPlayServer.url+"/play?play_id="+_this.currentPlayServer.play_id;if(startime>0){url=url+"#t="+startime.toString()}}video.attr("src",url);if(device=="apple"&&method=="transcode"){$.get(url)}};this.play=function(){if(device=="apple"&&method=="transcode"){setTimeout(function(){video.get(0).play()},1e3)}else{video.get(0).play()}};this.setUp=function(metadata){duration=parseInt(metadata["format"]["duration"]).toString();$(".slider").attr("max",duration);$(".slider").show();if(metadata["format"]["format_name"].indexOf("mp4")>-1){method="play";$(".slider").hide()}video.on("timeupdate",function(event){if(stop_duration_update){return}var time=offset_duration+parseInt(this.currentTime);if(time%10==0&&latest_position_stored!=time&&time>0&&!watchedIncremented){latest_position_stored=time;var times=0;if(time/100*5>duration-time){watchedIncremented=true;times=1;time=0}$.post("/api/user/watching",{show_id:show_id,episode_number:episode_number,position:time,times:times,_xsrf:getCookie("_xsrf")})}$(".slider").val(time.toString());var format="mm:ss";if(time>=3600){format="hh:mm:ss"}$("time_position").html((new Date).setSeconds(time).toString())});video.on("canplay",function(){video.currentTime=startTime});video.on("ended",function(){$("#seplis-modal").modal("hide")});$(".slider").on("touchstart",function(){stop_duration_update=true});$(".slider").on("touchend",function(){stop_duration_update=false});$(".slider").on("mousedown",function(){stop_duration_update=true});$(".slider").on("mouseup",function(){stop_duration_update=false});$(".slider").change(function(event){video.get(0).pause();$.get(_this.currentPlayServer.url+"/"+session+"/cancel");session=guid();var start=parseInt($(this).val());_this.setStart(start);watchedIncremented=false;_this.play()})};var checkServer=function(play_server){$.getJSON(play_server.url+"/metadata",{play_id:play_server.play_id},function(data){if(_this.currentPlayServer)return;$(".video").removeClass("hide");$(".loading-video").hide();_this.currentPlayServer=play_server;_this.setUp(data);_this.setStart(start_pos);_this.play()}).error(function(jqxhr,textStatus,error){if(_this.currentPlayServer)return;if(jqxhr.status==404){$(".episode-404").removeClass("hide")}else{$(".episode-no-connection").removeClass("hide")}$(".loading-video").hide()})};for(i in play_servers){var ps=play_servers[i];if(ps.url.substr(ps.url.length-1)=="/"){ps.url=ps.url.substr(0,ps.url.length-1)}checkServer(ps)}};$.fn.seplis_play=function(play_servers,show_id,episode_number,start_pos,options){return this.each(function(){var video=$(this);if(video.data("seplis_play"))return;var seplis_play=new SeplisPlay(video,play_servers,show_id,episode_number,start_pos,options);video.data("seplis_play",seplis_play)})}})(jQuery);$(function(){$("#sign-in-form").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/sign-in",$(this).serialize(),{done:function(data){location.href=$("#next").val()},always:function(){btn.button("reset")}})});$("#sign-up-form").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/sign-up",$(this).serialize(),{done:function(data){location.href=$("#next").val()},always:function(){btn.button("reset")}})})});var Template=function(){};Template.prototype.show=function(template,to,data){to.html(_.template(template,data))};$(document).on("click",".btn-fan",function(event){$(this).blur();var _this=this;api.post("/api/fan",$.param({show_id:$(_this).attr("show-id"),"do":"fan"}),{done:function(){var fan_count=$(_this).parent().find(".btn-fan-count");fan_count.html(parseInt(fan_count.html())+1);$(_this).toggleClass("btn-fan btn-unfan")}})});$(document).on("click",".btn-unfan",function(event){$(this).blur();var _this=this;api.post("/api/fan",$.param({show_id:$(_this).attr("show-id"),"do":"unfan"}),{done:function(){var fan_count=$(_this).parent().find(".btn-fan-count");fan_count.html(parseInt(fan_count.html())-1);$(_this).toggleClass("btn-unfan btn-fan")}})});$(document).on("click",".not-watched",function(event){$(this).blur();var btn=$(this);btn.button("loading");api.post("/api/watched",$.param({show_id:btn.attr("show-id"),number:btn.attr("episode-number"),"do":"incr"}),{done:function(){var watched_count=btn.parent().find(".times-watched");watched_count.html(parseInt(watched_count.html())+1);btn.toggleClass("watched not-watched");btn.attr("data-toggle","dropdown")},always:function(){btn.button("reset")}})});$(document).on("click",".watched-button",function(event){$(this).blur();var btn=$(this);if(btn.attr("disabled")){return false}var watched_count=btn.parent().parent().find(".times-watched");var todo=btn.attr("do");if(todo=="decr"&&parseInt(watched_count.html())<=1){todo="delete"}btn.button("loading");api.post("/api/watched",$.param({show_id:btn.attr("show-id"),number:btn.attr("episode-number"),"do":todo}),{done:function(){var count=0;if(btn.attr("do")=="incr"){count=parseInt(watched_count.html())+1}else{count=parseInt(watched_count.html())-1}watched_count.html(count);if(count<=0){var btn_watched=btn.parent().parent().find(".watched");btn_watched.toggleClass("watched not-watched");btn_watched.attr("data-toggle","")}},always:function(){btn.button("reset")}})});$("#form-multi-watched").submit(function(event){event.preventDefault();var btn=$(this).find(".btn");btn.button("loading");api.post("/api/watched",$(this).serialize(),{done:function(data){location.reload()},always:function(data){btn.button("reset")}})});$("#button-multi-watched").click(function(){setTimeout(function(){$("#form-from-episode-number").focus()},10)});$(function(){$("#form-play-server").submit(function(event){event.preventDefault();var btn=$(this).find("button");btn.button("loading");api.post("/api/user/play-server",$(this).serialize(),{done:function(data){location.href="/user/play-servers"},always:function(){btn.button("reset")}})});$("#button-play-server-delete").click(function(event){event.preventDefault();if(!confirm("Sure you wan't to delete this play server?")){return}var btn=$(this);btn.button("loading");api.delete("/api/user/play-server",{id:$(this).attr("play-server-id")},{done:function(data){location.href="/user/play-servers"},always:function(){btn.button("reset")}})});$(".episode-play-servers").click(function(){var menu=$(this).parent().find(".dropdown-menu");api.get("/api/show-episode/play-servers",{show_id:$(this).attr("show-id"),episode_number:$(this).attr("episode-number")},{done:function(data){menu.html(_.template("<% for (var ps in play_servers) { %>"+"<li>"+"<a "+'href="/play-episode?play_server_id=<%- play_servers[ps].play_server.id %>&play_id=<%- play_servers[ps].play_id %>"'+">"+"<%- play_servers[ps].play_server.name %>"+"</a>"+"</li>"+"<% } %>",{play_servers:data}))}})})});