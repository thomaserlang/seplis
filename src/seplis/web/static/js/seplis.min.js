function tag_generate_html(e,t){return _.template(multiline(function(){}),{tag:e,relation_id:t,current_user:current_user})}function show_tags(e,t,n){e.children(".btn-group").slice(1).remove();if(t.length===0){e.append(multiline(function(){}));return}$.each(t,function(t,r){e.append(tag_generate_html(r,n))})}$(".add-show-tag").submit(function(e){e.preventDefault(),api.post("/user-tags",$(this).serialize(),{done:function(e){alert(e)}})}),$(document).on("submit",".form-tag",function(e){e.preventDefault();var t=this,n=$(t).find(".tag-relation-id").val();api.post("/user-tags",$(this).serialize(),{done:function(e){api.get("/user-tags",$(t).serialize(),{done:function(e){show_tags($("#tags-"+n),e,n)}}),$(t).find('input[name="name"]').val(""),$(document).click()}})}),$(".btn-add-tag").click(function(){var e=this;setInterval(function(){$(e).parent().find(".input-add-tag").focus()},10)}),$(".btn-group").on("click",".link-tag-delete",function(e){e.preventDefault(),$(this).parent().find(".form-tag").submit()});;;function get_show_play_next(e){$("#show-play-next-image").attr("data-target","").attr("href",""),api.get("/api/show-play-next",{show_id:e},{done:function(t){$("#show-play-next-image").attr("data-target","#seplis-modal").attr("href","/modal/play-episode?show_id="+e+"&episode_number="+t.number)}})}$(function(){$("#form-new-show").submit(function(e){e.preventDefault(),api.post("/api/show-new",$(this).serialize(),{done:function(e){location.href="/show/"+e.id}})}),$("#form-edit-show").submit(function(e){e.preventDefault(),api.post("/api/show-edit/"+$(this).attr("show-id"),$(this).serialize(),{done:function(e){$.growl({title:"Success!",message:"The show has been updated.",location:"tc"})}})}),$("#alternative-titles").length&&$("#alternative-titles").select2({tags:[]}),$("date.show-date").each(function(){var e=moment.utc($(this).attr("title"),moment.iso_8601).diff(moment.utc(),"hours");e<0?e=0:e>0&&e<24&&(e=24);var t=(e/24).toString();t=="0"?t="Today":t=="1"?t="Tomorrow":t="in "+Math.ceil(t)+" days",$(this).text(t)}),$(".season-select select").change(function(){location.href="/show/"+$(this).attr("show-id")+"?season="+$(this).val()}),$(".show-info .description .description-text").dotdotdot({after:"a.readmore",tolerance:0,height:70}),$(".dropdown-form input, .dropdown-form label, .dropdown-form .btn").click(function(e){e.stopPropagation()}),$(".show-list-description-text").dotdotdot({after:"a.readmore",tolerance:0,height:40})});$(document).on("click",".btn-fan",function(e){$(this).blur();var t=this;api.post("/api/fan",$.param({show_id:$(t).attr("show-id"),"do":"fan"}),{done:function(){var e=$(t).parent().find(".btn-fan-count");e.html(parseInt(e.html())+1),$(t).toggleClass("btn-fan btn-unfan")}})}),$(document).on("click",".btn-unfan",function(e){$(this).blur();var t=this;api.post("/api/fan",$.param({show_id:$(t).attr("show-id"),"do":"unfan"}),{done:function(){var e=$(t).parent().find(".btn-fan-count");e.html(parseInt(e.html())-1),$(t).toggleClass("btn-unfan btn-fan")}})}),$(document).on("click",".not-watched",function(e){$(this).blur();var t=$(this);t.button("loading"),api.post("/api/watched",$.param({show_id:t.attr("show-id"),number:t.attr("episode-number"),"do":"incr"}),{done:function(){var e=t.parent().find(".times-watched");e.html(parseInt(e.html())+1),t.toggleClass("watched not-watched"),t.attr("data-toggle","dropdown")},always:function(){t.button("reset")}})}),$(document).on("click",".watched-button",function(e){$(this).blur();var t=$(this);if(t.attr("disabled"))return!1;var n=t.parent().parent().find(".times-watched"),r=t.attr("do");r=="decr"&&parseInt(n.html())<=1&&(r="delete"),t.button("loading"),api.post("/api/watched",$.param({show_id:t.attr("show-id"),number:t.attr("episode-number"),"do":r}),{done:function(){var e=0;t.attr("do")=="incr"?e=parseInt(n.html())+1:e=parseInt(n.html())-1,n.html(e);if(e<=0){var r=t.parent().parent().find(".watched");r.toggleClass("watched not-watched"),r.attr("data-toggle","")}},always:function(){t.button("reset")}})}),$("#form-multi-watched").submit(function(e){e.preventDefault();var t=$(this).find(".btn");t.button("loading"),api.post("/api/watched",$(this).serialize(),{done:function(e){location.reload()},always:function(e){t.button("reset")}})}),$("#button-multi-watched").click(function(){setTimeout(function(){$("#form-from-episode-number").focus()},10)});var Template=function(){};Template.prototype.show=function(e,t,n){t.html(_.template(e,n))};$(function(){moment.locale("en",{calendar:{lastDay:"[Yesterday] (dddd)",sameDay:"[Today] (dddd)",nextDay:"[Tomorrow] (dddd)",lastWeek:"[Last] dddd",nextWeek:"dddd",sameElse:"dddd"}}),$(".airdates date").each(function(){$(this).text(moment.utc($(this).attr("title"),moment.iso_8601).calendar())})});(function(e){var t=function(t,n,r,s,o,u){var a=this,f=e.extend({},u);this.currentPlayServer=null,this.getDevice=function(){return navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?"apple":"default"};var l=function(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}(),c=function(e){var t=document.cookie.match("\\b"+e+"=([^;]*)\\b");return t?t[1]:undefined},h=l(),p=this.getDevice(),d=0,v=!1,m=-1,g=10,y="transcode",b=0,w=!1,E=0;this.setStart=function(n){b=n;if(y=="transcode"){var r=a.currentPlayServer.url+"/transcode?play_id="+a.currentPlayServer.play_id+"&device="+p+"&session="+h+"&start="+n.toString();d=n}else{var r=a.currentPlayServer.url+"/play?play_id="+a.currentPlayServer.play_id;n>0&&(r=r+"#t="+n.toString())}t.attr("src",r),p=="apple"&&y=="transcode"&&e.get(r)},this.play=function(){p=="apple"&&y=="transcode"?setTimeout(function(){t.get(0).play()},1e3):t.get(0).play()},this.setUp=function(n){E=parseInt(n.format.duration).toString(),e(".slider").attr("max",E),e(".slider").show(),n.format.format_name.indexOf("mp4")>-1&&(y="play",e(".slider").hide()),t.on("timeupdate",function(t){if(v)return;var n=d+parseInt(this.currentTime);if(n%10==0&&m!=n&&n>0&&!w){m=n;var i=0;n/100*5>E-n&&(w=!0,i=1,n=0),e.post("/api/user/watching",{show_id:r,episode_number:s,position:n,times:i,_xsrf:c("_xsrf")})}e(".slider").val(n.toString());var o="mm:ss";n>=3600&&(o="hh:mm:ss"),e("time_position").html((new Date).setSeconds(n).toString())}),t.on("canplay",function(){t.currentTime=b}),t.on("ended",function(){e("#seplis-modal").modal("hide")}),e(".slider").on("touchstart",function(){v=!0}),e(".slider").on("touchend",function(){v=!1}),e(".slider").on("mousedown",function(){v=!0}),e(".slider").on("mouseup",function(){v=!1}),e(".slider").change(function(n){t.get(0).pause(),e.get(a.currentPlayServer.url+"/"+h+"/cancel"),h=l();var r=parseInt(e(this).val());a.setStart(r),w=!1,a.play()})};var S=function(t){e.getJSON(t.url+"/metadata",{play_id:t.play_id},function(n){if(a.currentPlayServer)return;e(".video").removeClass("hide"),e(".loading-video").hide(),a.currentPlayServer=t,a.setUp(n),a.setStart(o),a.play()}).error(function(t,n,r){if(a.currentPlayServer)return;t.status==404?e(".episode-404").removeClass("hide"):e(".episode-no-connection").removeClass("hide"),e(".loading-video").hide()})};for(i in n){var x=n[i];x.url.substr(x.url.length-1)=="/"&&(x.url=x.url.substr(0,x.url.length-1)),S(x)}};e.fn.seplis_play=function(n,r,i,s,o){return this.each(function(){var u=e(this);if(u.data("seplis_play"))return;var a=new t(u,n,r,i,s,o);u.data("seplis_play",a)})}})(jQuery);function Api_error(e,t,n,r,i){this.status_code=e,this.code=t,this.errors=n,this.message=r,this.extra=i}function Api(){this.default_error_callback=null,this.loader_gif=null}function getCookie(e){var t=document.cookie.match("\\b"+e+"=([^;]*)\\b");return!t&&e=="_xsrf"?"not_found":t?t[1]:undefined}Api_error.prototype.toString(function(){return this.message+"("+status_code+")"}),Api.prototype._method=function(e,t,n,r){var i={done:null,error:this.default_error_callback,always:null};typeof r!="undefined"&&$.extend(i,r),headers={"X-XSRFToken":getCookie("_xsrf")},this.loader_gif!==null&&$(".api_request_loader").html('<img src="'+this.loader_gif+'" />'),$.ajax({url:e,type:t,data:n,headers:headers}).error(function(e,t){e.status>=400&&e.status<=600?error=new Api_error(e.status,e.responseJSON.code,e.responseJSON.errors,e.responseJSON.message,e.responseJSON.extra):error=new Api_error(null,null,null,"can't access the seplis api server",null),i.error!==null&&i.error(error)}).done(function(e){i.done!==null&&i.done(e)}).always(function(){this.loader_gif!==null&&$(".api_request_loader").empty(),i.always!==null&&i.always(n)})},Api.prototype.post=function(e,t,n){this._method(e,"POST",t,n)},Api.prototype.get=function(e,t,n){this._method(e,"GET",t,n)},Api.prototype.delete=function(e,t,n){this._method(e,"DELETE",t,n)};$(function(){$("#sign-in-form").submit(function(e){e.preventDefault();var t=$(this).find("button");t.button("loading"),api.post("/api/sign-in",$(this).serialize(),{done:function(e){location.href=$("#next").val()},always:function(){t.button("reset")}})}),$("#sign-up-form").submit(function(e){e.preventDefault();var t=$(this).find("button");t.button("loading"),api.post("/api/sign-up",$(this).serialize(),{done:function(e){location.href=$("#next").val()},always:function(){t.button("reset")}})})});String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1},$(function(){$(".autocomplete").autocomplete({serviceUrl:"/api/suggest",paramName:"q",noCache:!0,width:400,triggerSelectOnValidInput:!1,transformResult:function(e){return e=$.parseJSON(e),{suggestions:$.map(e,function(e){return{value:e.title.toString(),data:e}})}},formatResult:function(e,t){return _.template('<span class="title"><%- title %></span>',e.data)},onSelect:function(e){location.href="/show/"+e.data.id}}),$(".change-page").change(function(){var e=$.url(location.href);p=e.param(),p.page=$(this).val(),location.href=e.attr("path")+"?"+$.param(p)}),$(".change-layout").click(function(e){e.preventDefault(),$.cookie("layout",$(this).attr("data-layout"),{expires:365}),location.reload()}),$(document).on("hidden.bs.modal","#seplis-modal",function(e){var t=$(e.target).removeData("bs.modal").find(".modal-content");t.empty()})});$(function(){$("#form-play-server").submit(function(e){e.preventDefault();var t=$(this).find("button");t.button("loading"),api.post("/api/user/play-server",$(this).serialize(),{done:function(e){location.href="/user/play-servers"},always:function(){t.button("reset")}})}),$("#button-play-server-delete").click(function(e){e.preventDefault();if(!confirm("Sure you wan't to delete this play server?"))return;var t=$(this);t.button("loading"),api.delete("/api/user/play-server",{id:$(this).attr("play-server-id")},{done:function(e){location.href="/user/play-servers"},always:function(){t.button("reset")}})}),$(".episode-play-servers").click(function(){var e=$(this).parent().find(".dropdown-menu");api.get("/api/show-episode/play-servers",{show_id:$(this).attr("show-id"),episode_number:$(this).attr("episode-number")},{done:function(t){e.html(_.template('<% for (var ps in play_servers) { %><li><a href="/play-episode?play_server_id=<%- play_servers[ps].play_server.id %>&play_id=<%- play_servers[ps].play_id %>"><%- play_servers[ps].play_server.name %></a></li><% } %>',{play_servers:t}))}})})});