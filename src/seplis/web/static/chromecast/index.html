<html>
    <head>
        <title>SEPLIS CAST</title>
            <script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
            <script src="//www.gstatic.com/cast/sdk/libs/mediaplayer/1.0.0/media_player.js"></script>
            <script
              src="https://code.jquery.com/jquery-3.2.1.min.js"
              integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
              crossorigin="anonymous"></script>
            <style>
                body {
                    background-color: #000; 
                    font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
                }

                #media {
                    
                }

                #logocenter {
                    position: relative;
                    top: 50%;
                    transform: translateY(-50%);
                }

                #logocenter .text {
                    text-align: center;
                    font-size: 200px;
                    color: #428bca;
                }

                video {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    left: 0;
                    top: 0;
                    opacity: 1;
                    z-index: 1;
                    visibility: visible;
                }
            </style>
    </head>
    <body>
        <video id="media"></video>
        <div id="logocenter">
            <div class="text">
                SEPLIS
            </div>
        </div>
        <script>
            var player = null;
            var host = null;
            var currentInfo = null;
            var token = null;
            var lastSavedTime = 0;
            var watchedIncremented = false;
            var pingTimer = null;
            var currentPlayingUrl = null;

            var mediaElement = document.getElementById('media');
            var mediaManager = new cast.receiver.MediaManager(mediaElement);
            
            mediaManager['onLoadOrig'] = mediaManager.onLoad.bind(mediaManager);
            mediaManager.onLoad = function(event) {
                lastSavedTime = 0;
                var senders = castReceiverManager.getSenders();
                for (var i in senders) {
                    messageInfo.send(senders[i], currentInfo);
                }

                if (player !== null) {
                    player.unload();
                    player = null;
                }
                console.log(event.data['media']);
                console.log(event.data['media']['contentId']);
                if (event.data['media'] && event.data['media']['contentId']) {
                    console.log('Starting media application');
                    var url = event.data['media']['contentId'];
                    currentPlayingUrl = url;
                    startPingTimer();
                    var initStart = event.data['media']['currentTime'] || 0;
                    mediaElement.autoplay = event.data['autoplay'] || true;
                    host = new cast.player.api.Host({
                        'mediaElement': mediaElement, 
                        'url': url
                    });
                    var protocol = cast.player.api.CreateHlsStreamingProtocol(host);
                    player = new cast.player.api.Player(host);
                    player.load(protocol, initStart);
                }
            }

            mediaManager['onEndedOrig'] = mediaManager.onEnded.bind(mediaManager);
            mediaManager.onEnded = function() {
                currentInfo = null;
                token = null;
                currentPlayingUrl = null;
                mediaManager['onEndedOrig']();
            }

            var castReceiverManager = cast.receiver.CastReceiverManager.getInstance();         

            var messageInfo = castReceiverManager.getCastMessageBus(
                'urn:x-cast:net.seplis.cast.info',
                cast.receiver.CastMessageBus.MessageType.JSON
            );
            messageInfo.onMessage = function(event) {
                currentInfo = event.data;
                token = currentInfo.token;
                delete currentInfo['token'];
            }

            var messageSendInfo = castReceiverManager.getCastMessageBus(
                'urn:x-cast:net.seplis.cast.sendinfo',
                cast.receiver.CastMessageBus.MessageType.JSON
            );
            messageSendInfo.onMessage = function(event) {
                if (!currentInfo)
                    return;
                messageInfo.send(event.senderId, currentInfo);
            }

            castReceiverManager.onSenderConnected = function(event) {
                messageInfo.send(event.senderId, currentInfo);
            }

            castReceiverManager.start();

            $('video').on('timeupdate', function(){
                if (!currentInfo)
                    return;
                let time = Math.floor(this.currentTime);
                if (this.seekable.length <= 1 || this.seekable.end(0) <= 1)
                    time += currentInfo['startTime'];
                if (currentInfo['startTime'] == time)
                    return;
                if (lastSavedTime == time)
                    return;
                lastSavedTime = time;                
                if (time < 10)
                    return;
                if ((time % 10) != 0)
                    return;

                let duration = parseInt(currentInfo['metadata']['format']['duration']);
                let watched = (((time / 100) * 10) > (duration-time));

                let url = currentInfo['apiUrl'] +
                    '/1/shows/'+currentInfo['show']['id'].toString()+
                    '/episodes/'+currentInfo['episode']['number'].toString();
                let putData = {};
                if (watched) {
                    if (!watchedIncremented) {
                        watchedIncremented = true;
                        url += '/watched';
                    }
                } else {
                    watchedIncremented = false;
                    url += '/watching';
                    putData['position'] = time;
                }
                $.ajax({
                    url: url,
                    type: 'PUT',
                    data: JSON.stringify(putData),
                    dataType: 'json',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer '+token,
                    }
                });
            });

            function startPingTimer() {
                clearTimeout(pingTimer);
                if (!currentPlayingUrl)
                    return;
                pingTimer = setTimeout(() => {
                    $.get(currentPlayingUrl+'&action=ping');
                    startPingTimer();
                }, 2000);
            }
        </script>
    </body>
</html>